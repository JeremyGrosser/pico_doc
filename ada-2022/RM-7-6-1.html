<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
    <TITLE>Completion and Finalization</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <META NAME="Author" CONTENT="JTC1/SC22/WG9/ARG, by Randall Brukardt, ARG Editor">
    <META NAME="GENERATOR" CONTENT="Arm_Form.Exe, Ada Reference Manual generator">
    <STYLE type="text/css">
    H4.centered {text-align: center}
    SPAN.swiss {font-family: Arial, Helvetica, sans-serif; font-size: 92%}
    SPAN.roman {font-family: "Times New Roman", Times, serif}
    DIV.paranum {float: left; font-family: Arial, Helvetica, sans-serif; font-size: 64%; width: 2.8em; margin-left: -0.4em; margin-right: -3.0em; margin-top: 0.2em}
    TT {font-family: "Courier New", monospace}
    DT {display: compact}
    A.Bar:link {font-family: Arial, Helvetica, sans-serif; font-style: normal; text-decoration: none; color: rgb(204,204,51)}
    A.Bar:visited {font-family: Arial, Helvetica, sans-serif; font-style: normal; text-decoration: none; color: rgb(204,204,51)}
    DIV.Normal {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 1.8em; margin-bottom: 0.6em}
    DIV.Notes {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 4.3em; margin-bottom: 0.6em}
    DIV.Bulleted-NoPrefix {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.8em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em}
    DIV.Bulleted {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.8em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em; display: list-item; list-style-type: disc}
    </STYLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFF0" LINK="#000080" VLINK="#330033" ALINK="#0000FF">
<DIV><SPAN Style="font-size:200%; color: rgb(0,0,153)"><B>Ada Reference Manual</B> (Ada 2022 Draft 35)</SPAN> &mdash; <A HREF="RM-TTL.html"><B>Legal Information</B></A></DIV>
<div style="margin-top: 0.6em; margin-bottom: 0.0em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-4.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-7-6.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-8.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</div>
<HR>
<H1>7.6.1 Completion and Finalization</H1>
<div class="paranum"><a name="p1">1</a></div>
<div class="Normal">This subclause defines <I>completion</I> and <I>leaving</I> 
of the execution of constructs and entities. A <I>master</I> is the execution 
of a construct that includes finalization of local objects after it is 
complete (and after waiting for any local tasks &mdash; see <A HREF="RM-9-3.html">9.3</A>), 
but before leaving. Other constructs and entities are left immediately 
upon completion. <A NAME="I4167"></A><A NAME="I4168"></A></div>

<H4 Class="centered">Dynamic Semantics</H4>
<div class="paranum"><a name="p2">2/2</a></div>
<div class="Normal"><A NAME="I4169"></A><A NAME="I4170"></A>The execution 
of a construct or entity is <I>complete</I> when the end of that execution 
has been reached, or when a transfer of control (see <A HREF="RM-5-1.html">5.1</A>) 
causes it to be abandoned. <A NAME="I4171"></A><A NAME="I4172"></A><A NAME="I4173"></A><A NAME="I4174"></A>Completion 
due to reaching the end of execution, or due to the transfer of control 
of an <SPAN Class="swiss"><A HREF="RM-5-7.html#S0193">exit_statement</A></SPAN>, 
return statement, <SPAN Class="swiss"><A HREF="RM-5-8.html#S0194">goto_statement</A></SPAN>, 
or <SPAN Class="swiss"><A HREF="RM-9-5-4.html#S0265">requeue_statement</A></SPAN> 
or of the selection of a <SPAN Class="swiss"><A HREF="RM-9-7-1.html#S0275">terminate_alternative</A></SPAN> 
is <I>normal completion</I>. Completion is <I>abnormal</I> otherwise 
&mdash; when control is transferred out of a construct due to abort or 
the raising of an exception.&nbsp;</div>
<div class="paranum"><a name="p3">3/5</a></div>
<div class="Normal"><A NAME="I4175"></A><A NAME="I4176"></A>After execution 
of a construct or entity is complete, it is <I>left</I>, meaning that 
execution continues with the next action, as defined for the execution 
that is taking place. <A NAME="I4177"></A>Leaving an execution happens 
immediately after its completion, except in the case of the execution 
of a <I>master construct</I>: <A NAME="I4178"></A><A NAME="I4179"></A>a 
body other than a <SPAN Class="swiss"><A HREF="RM-7-2.html#S0231">package_body</A></SPAN>; 
a <SPAN Class="swiss"><A HREF="RM-5-1.html#S0167">statement</A></SPAN>; 
or an <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN>, 
<SPAN Class="swiss"><A HREF="RM-6-4.html#S0218">function_call</A></SPAN>, 
or <SPAN Class="swiss"><A HREF="RM-3-5.html#S0037">range</A></SPAN> that 
is not part of an enclosing <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN>, 
<SPAN Class="swiss"><A HREF="RM-6-4.html#S0218">function_call</A></SPAN>, 
<SPAN Class="swiss"><A HREF="RM-3-5.html#S0037">range</A></SPAN>, or 
<SPAN Class="swiss"><A HREF="RM-5-1.html#S0168">simple_statement</A></SPAN> 
other than a <SPAN Class="swiss"><A HREF="RM-6-5.html#S0222">simple_return_statement</A></SPAN>. 
The term <I>master</I> by itself refers to the execution of a master 
construct. A master is finalized after it is complete, and before it 
is left.</div>
<div class="paranum"><a name="p4">4</a></div>
<div class="Normal"><A NAME="I4180"></A>For the <I>finalization</I> of 
a master, dependent tasks are first awaited, as explained in <A HREF="RM-9-3.html">9.3</A>. 
Then each object whose accessibility level is the same as that of the 
master is finalized if the object was successfully initialized and still 
exists. These actions are performed whether the master is left by reaching 
the last statement or via a transfer of control. When a transfer of control 
causes completion of an execution, each included master is finalized 
in order, from innermost outward.&nbsp;</div>
<div class="paranum"><a name="p5">5</a></div>
<div class="Normal" style="margin-bottom: 0.4em"><A NAME="I4181"></A>For 
the <I>finalization</I> of an object:&nbsp;</div>
<div class="paranum"><a name="p6">6/3</a></div>
<div class="Bulleted">If the full type of the object is an elementary 
type, finalization has no effect;&nbsp;</div>
<div class="paranum"><a name="p7">7/3</a></div>
<div class="Bulleted">If the full type of the object is a tagged type, 
and the tag of the object identifies a controlled type, the Finalize 
procedure of that controlled type is called;</div>
<div class="paranum"><a name="p8">8/3</a></div>
<div class="Bulleted">If the full type of the object is a protected type, 
or if the full type of the object is a tagged type and the tag of the 
object identifies a protected type, the actions defined in <A HREF="RM-9-4.html">9.4</A> 
are performed;</div>
<div class="paranum"><a name="p9">9/3</a></div>
<div class="Bulleted">If the full type of the object is a composite type, 
then after performing the above actions, if any, every component of the 
object is finalized in an arbitrary order, except as follows:<A NAME="I4182"></A> 
if the object has a component with an access discriminant constrained 
by a per-object expression, this component is finalized before any components 
that do not have such discriminants; for an object with several components 
with such a discriminant, they are finalized in the reverse of the order 
of their <SPAN Class="swiss"><A HREF="RM-3-8.html#S0070">component_declaration</A></SPAN>s; 
</div>
<div class="paranum"><a name="p9.1">9.1/2</a></div>
<div class="Bulleted">If the object has coextensions (see <A HREF="RM-3-10-2.html">3.10.2</A>), 
each coextension is finalized after the object whose access discriminant 
designates it.</div>
<div class="paranum"><a name="p10">10</a></div>
<div class="Normal"><A NAME="I4183"></A>Immediately before an instance 
of Unchecked_Deallocation reclaims the storage of an object, the object 
is finalized. If an instance of Unchecked_Deallocation is never applied 
to an object created by an <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN>, 
the object will still exist when the corresponding master completes, 
and it will be finalized then.</div>
<div class="paranum"><a name="p11">11/3</a></div>
<div class="Normal">The finalization of a master performs finalization 
of objects created by declarations in the master in the reverse order 
of their creation. After the finalization of a master is complete, the 
objects finalized as part of its finalization cease to <I>exist</I>, 
as do any types and subtypes defined and created within the master.<A NAME="I4184"></A> 
<A NAME="I4185"></A><A NAME="I4186"></A></div>
<div class="paranum"><a name="p11.1">11.1/3</a></div>
<div class="Normal" style="margin-bottom: 0.4em">&nbsp;&nbsp;Each nonderived access 
type <I>T</I> has an associated <I>collection</I>,<A NAME="I4187"></A> 
which is the set of objects created by <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN>s 
of <I>T</I>, or of types derived from <I>T</I>. Unchecked_Deallocation 
removes an object from its collection. Finalization of a collection consists 
of finalization of each object in the collection, in an arbitrary order. 
The collection of an access type is an object implicitly declared at 
the following place:<A NAME="I4188"></A></div>
<div class="paranum"><a name="p11.2">11.2/3</a></div>
<div class="Bulleted">For a named access type, the first freezing point 
(see <A HREF="RM-13-14.html">13.14</A>) of the type.</div>
<div class="paranum"><a name="p11.3">11.3/3</a></div>
<div class="Bulleted">For the type of an access parameter, the call that 
contains the <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN>.</div>
<div class="paranum"><a name="p11.4">11.4/3</a></div>
<div class="Bulleted">For the type of an access result, within the master 
of the call (see <A HREF="RM-3-10-2.html">3.10.2</A>).&nbsp;</div>
<div class="paranum"><a name="p11.5">11.5/3</a></div>
<div class="Bulleted">For any other anonymous access type, the first 
freezing point of the innermost enclosing declaration.&nbsp;</div>
<div class="paranum"><a name="p12">12/2</a></div>
<div class="Normal"><A NAME="I4189"></A>The target of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0173">assignment_statement</A></SPAN> 
is finalized before copying in the new value, as explained in <A HREF="RM-7-6.html">7.6</A>.</div>
<div class="paranum"><a name="p13">13/3</a></div>
<div class="Normal">The master of an object is the master enclosing its 
creation whose accessibility level (see <A HREF="RM-3-10-2.html">3.10.2</A>) 
is equal to that of the object, except in the case of an anonymous object 
representing the result of an <SPAN Class="swiss"><A HREF="RM-4-3.html#S0106">aggregate</A></SPAN> 
or function call. If such an anonymous object is part of the result of 
evaluating the actual parameter expression for an explicitly aliased 
parameter of a function call, the master of the object is the innermost 
master enclosing the evaluation of the <SPAN Class="swiss"><A HREF="RM-4-3.html#S0106">aggregate</A></SPAN> 
or function call, excluding the <SPAN Class="swiss"><A HREF="RM-4-3.html#S0106">aggregate</A></SPAN> 
or function call itself. Otherwise, the master of such an anonymous object 
is the innermost master enclosing the evaluation of the <SPAN Class="swiss"><A HREF="RM-4-3.html#S0106">aggregate</A></SPAN> 
or function call, which may be the <SPAN Class="swiss"><A HREF="RM-4-3.html#S0106">aggregate</A></SPAN> 
or function call itself.&nbsp;</div>
<div class="paranum"><a name="p13.1">13.1/3</a></div>
<div class="Normal">&nbsp;&nbsp;In the case of an <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN> 
that is a master, finalization of any (anonymous) objects occurs after 
completing evaluation of the <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN> 
and all use of the objects, prior to starting the execution of any subsequent 
construct.</div>

<H4 Class="centered">Bounded (Run-Time) Errors</H4>
<div class="paranum"><a name="p14">14/1</a></div>
<div class="Normal" style="margin-bottom: 0.4em"><A NAME="I4190"></A>It 
is a bounded error for a call on Finalize or Adjust that occurs as part 
of object finalization or assignment to propagate an exception. The possible 
consequences depend on what action invoked the Finalize or Adjust operation: 
</div>
<div class="paranum"><a name="p15">15</a></div>
<div class="Bulleted"><A NAME="I4191"></A>For a Finalize invoked as part 
of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0173">assignment_statement</A></SPAN>, 
Program_Error is raised at that point.</div>
<div class="paranum"><a name="p16">16/5</a></div>
<div class="Bulleted">For an Adjust invoked as part of assignment operations 
other than those invoked as part of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0173">assignment_statement</A></SPAN>, 
some of the adjustments due to be performed can be performed, and then 
Program_Error is raised. During its propagation, finalization may be 
applied to objects whose Adjust failed. <A NAME="I4192"></A>For an Adjust 
invoked as part of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0173">assignment_statement</A></SPAN>, 
any other adjustments due to be performed are performed, and then Program_Error 
is raised.&nbsp;</div>
<div class="paranum"><a name="p17">17</a></div>
<div class="Bulleted"><A NAME="I4193"></A>For a Finalize invoked as part 
of a call on an instance of Unchecked_Deallocation, any other finalizations 
due to be performed are performed, and then Program_Error is raised. 
</div>
<div class="paranum"><a name="p17.1">17.1/3</a></div>
<div class="Bulleted"><SPAN STYLE="font-size: 80%"><I>This paragraph 
was deleted.</I></SPAN></div>
<div class="paranum"><a name="p17.2">17.2/1</a></div>
<div class="Bulleted"><A NAME="I4194"></A>For a Finalize invoked due 
to reaching the end of the execution of a master, any other finalizations 
associated with the master are performed, and Program_Error is raised 
immediately after leaving the master.</div>
<div class="paranum"><a name="p18">18/2</a></div>
<div class="Bulleted"><A NAME="I4195"></A>For a Finalize invoked by the 
transfer of control of an <SPAN Class="swiss"><A HREF="RM-5-7.html#S0193">exit_statement</A></SPAN>, 
return statement, <SPAN Class="swiss"><A HREF="RM-5-8.html#S0194">goto_statement</A></SPAN>, 
or <SPAN Class="swiss"><A HREF="RM-9-5-4.html#S0265">requeue_statement</A></SPAN>, 
Program_Error is raised no earlier than after the finalization of the 
master being finalized when the exception occurred, and no later than 
the point where normal execution would have continued. Any other finalizations 
due to be performed up to that point are performed before raising Program_Error. 
</div>
<div class="paranum"><a name="p19">19</a></div>
<div class="Bulleted">For a Finalize invoked by a transfer of control 
that is due to raising an exception, any other finalizations due to be 
performed for the same master are performed; Program_Error is raised 
immediately after leaving the master.&nbsp;</div>
<div class="paranum"><a name="p20">20</a></div>
<div class="Bulleted">For a Finalize invoked by a transfer of control 
due to an abort or selection of a terminate alternative, the exception 
is ignored; any other finalizations due to be performed are performed. 
</div>

<H4 Class="centered">Implementation Permissions</H4>
<div class="paranum"><a name="p20.1">20.1/3</a></div>
<div class="Normal">&nbsp;&nbsp;If the execution of an <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN> 
propagates an exception, any parts of the allocated object that were 
successfully initialized may be finalized as part of the finalization 
of the innermost master enclosing the <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN>.</div>
<div class="paranum"><a name="p20.2">20.2/3</a></div>
<div class="Normal">&nbsp;&nbsp;The implementation may finalize objects created 
by <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN>s 
for an access type whose storage pool supports subpools (see <A HREF="RM-13-11-4.html">13.11.4</A>) 
as if the objects were created (in an arbitrary order) at the point where 
the storage pool was elaborated instead of at the first freezing point 
of the access type.<A NAME="I4196"></A></div>
<div class="paranum"><a name="p21">21/5</a></div>
<div class="Notes">NOTE 1&nbsp;&nbsp;&nbsp;The rules of Clause <A HREF="RM-10.html">10</A> 
imply that immediately prior to partition termination, Finalize operations 
are applied to library-level controlled objects (including those created 
by <SPAN Class="swiss"><A HREF="RM-4-8.html#S0164">allocator</A></SPAN>s 
of library-level access types, except those already finalized). This 
occurs after waiting for library-level tasks to terminate.&nbsp;</div>
<div class="paranum"><a name="p22">22</a></div>
<div class="Notes">NOTE 2&nbsp;&nbsp;&nbsp;A constant is only constant 
between its initialization and finalization. Both initialization and 
finalization are allowed to change the value of a constant.</div>
<div class="paranum"><a name="p23">23</a></div>
<div class="Notes">NOTE 3&nbsp;&nbsp;&nbsp;Abort is deferred during certain 
operations related to controlled types, as explained in <A HREF="RM-9-8.html">9.8</A>. 
Those rules prevent an abort from causing a controlled object to be left 
in an ill-defined state.</div>
<div class="paranum"><a name="p24">24</a></div>
<div class="Notes">NOTE 4&nbsp;&nbsp;&nbsp;The Finalize procedure is 
called upon finalization of a controlled object, even if Finalize was 
called earlier, either explicitly or as part of an assignment; hence, 
if a controlled type is visibly controlled (implying that its Finalize 
primitive is directly callable), or is nonlimited (implying that assignment 
is allowed), its Finalize procedure is ideally designed to have no ill 
effect if it is applied a second time to the same object.&nbsp;</div>

<HR>
<div style="margin-top: 0.0em; margin-bottom: 0.6em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-4.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-7-6.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-8.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</div>
<DIV Style="margin-top:0.0em"><IMG SRC="AE_logo.gif" height=100 width=113 align=right ALT="Ada-Europe">
<SPAN Style="vertical-align: middle; font-size:120%">Ada 2005 and 2012 Editions sponsored in part by <SPAN Style="font-size: 125%"><A HREF="http://www.ada-europe.org/"><B>Ada-Europe</B></A></SPAN></SPAN></DIV>
</BODY>
</HTML>
