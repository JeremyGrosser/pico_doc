<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
    <TITLE>Protected Procedure Handlers</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <META NAME="Author" CONTENT="JTC1/SC22/WG9/ARG, by Randall Brukardt, ARG Editor">
    <META NAME="GENERATOR" CONTENT="Arm_Form.Exe, Ada Reference Manual generator">
    <STYLE type="text/css">
    H4.centered {text-align: center}
    SPAN.swiss {font-family: Arial, Helvetica, sans-serif; font-size: 92%}
    SPAN.roman {font-family: "Times New Roman", Times, serif}
    DIV.paranum {float: left; font-family: Arial, Helvetica, sans-serif; font-size: 64%; width: 2.8em; margin-left: -0.4em; margin-right: -3.0em; margin-top: 0.2em}
    TT {font-family: "Courier New", monospace}
    DT {display: compact}
    A.Bar:link {font-family: Arial, Helvetica, sans-serif; font-style: normal; text-decoration: none; color: rgb(204,204,51)}
    A.Bar:visited {font-family: Arial, Helvetica, sans-serif; font-style: normal; text-decoration: none; color: rgb(204,204,51)}
    DIV.Normal {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 1.8em; margin-bottom: 0.6em}
    DIV.Notes {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 4.3em; margin-bottom: 0.6em}
    DIV.Bulleted-NoPrefix {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.8em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em}
    DIV.Bulleted {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.8em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em; display: list-item; list-style-type: disc}
    DIV.WideHanging-Body {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 7.8em; margin-top: 0em; margin-bottom: 0.6em}
    DIV.WideHanging-Term {float: left; font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 1.8em; margin-top: 0em; margin-bottom: 0em}
    </STYLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFF0" LINK="#000080" VLINK="#330033" ALINK="#0000FF">
<DIV><SPAN Style="font-size:200%; color: rgb(0,0,153)"><B>Ada Reference Manual</B> (Ada 2022 Draft 35)</SPAN> &mdash; <A HREF="RM-TTL.html"><B>Legal Information</B></A></DIV>
<div style="margin-top: 0.6em; margin-bottom: 0.0em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-4.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3-2.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</div>
<HR>
<H1>C.3.1 Protected Procedure Handlers</H1>
<div class="Normal"><SPAN STYLE="font-size: 80%"><I>Paragraphs 1 through 
6 were moved to <A HREF="RM-J.html">Annex J</A>, &ldquo;<A HREF="RM-J.html">Obsolescent 
Features</A>&rdquo;.</I></SPAN>&nbsp;</div>

<H4 Class="centered">Static Semantics</H4>
<div class="paranum"><a name="p6.1">6.1/3</a></div>
<div class="Normal" style="margin-bottom: 0.4em">&nbsp;For a parameterless 
protected procedure, the following language-defined representation aspects 
may be specified:&nbsp;</div>
<div class="paranum"><a name="p6.2">6.2/3</a></div>
<div class="WideHanging-Term">&nbsp;Interrupt_Handler</div><div class="WideHanging-Body"><br clear="left">
 The type of aspect Interrupt_Handler is Boolean. If directly specified, 
the aspect_definition shall be a static expression. This aspect is never 
inherited; if not directly specified, the aspect is False.<A NAME="I8580"></A><A NAME="I8581"></A></div>
<div class="paranum"><a name="p6.3">6.3/3</a></div>
<div class="WideHanging-Term">&nbsp;Attach_Handler</div><div class="WideHanging-Body"><br clear="left">
 The aspect Attach_Handler is an <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN>, 
which shall be of type Interrupts.Interrupt_Id. This aspect is never 
inherited.<A NAME="I8582"></A><A NAME="I8583"></A></div>

<H4 Class="centered">Legality Rules</H4>
<div class="paranum"><a name="p7">7/3</a></div>
<div class="Normal">If either the Attach_Handler or Interrupt_Handler 
aspect are specified for a protected procedure, the corresponding <SPAN Class="swiss"><A HREF="RM-9-4.html#S0249">protected_type_declaration</A></SPAN> 
or <SPAN Class="swiss"><A HREF="RM-9-4.html#S0250">single_protected_declaration</A></SPAN> 
shall be a library-level declaration and shall not be declared within 
a generic body. <A NAME="I8584"></A>In addition to the places where Legality 
Rules normally apply (see <A HREF="RM-12-3.html">12.3</A>), this rule 
also applies in the private part of an instance of a generic unit.</div>
<div class="paranum"><a name="p8">8/3</a></div>
<div class="Normal"><SPAN STYLE="font-size: 80%"><I>This paragraph was 
deleted.</I></SPAN></div>

<H4 Class="centered">Dynamic Semantics</H4>
<div class="paranum"><a name="p9">9/3</a></div>
<div class="Normal">If the Interrupt_Handler aspect of a protected procedure 
is True, then the procedure may be attached dynamically, as a handler, 
to interrupts (see <A HREF="RM-C-3-2.html">C.3.2</A>). Such procedures 
are allowed to be attached to multiple interrupts.</div>
<div class="paranum"><a name="p10">10/3</a></div>
<div class="Normal"><A NAME="I8585"></A><A NAME="I8586"></A>The <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN> 
specified for the Attach_Handler aspect of a protected procedure <I>P</I> 
is evaluated as part of the creation of the protected object that contains 
<I>P</I>. The value of the <SPAN Class="swiss"><A HREF="RM-4-4.html#S0132">expression</A></SPAN> 
identifies an interrupt. As part of the initialization of that object, 
<I>P</I> (the <I>handler</I> procedure) is attached to the identified 
interrupt. <A NAME="I8587"></A><A NAME="I8588"></A>A check is made that 
the corresponding interrupt is not reserved. <A NAME="I8589"></A>Program_Error 
is raised if the check fails, and the existing treatment for the interrupt 
is not affected.</div>
<div class="paranum"><a name="p11">11/3</a></div>
<div class="Normal"><A NAME="I8590"></A><A NAME="I8591"></A><A NAME="I8592"></A>If 
the Ceiling_Locking policy (see <A HREF="RM-D-3.html">D.3</A>) is in 
effect, then upon the initialization of a protected object that contains 
a protected procedure for which either the Attach_Handler aspect is specified 
or the  Interrupt_Handler aspect is True, a check is made that the initial 
ceiling priority of the object is in the range of System.Interrupt_Priority. 
<A NAME="I8593"></A>If the check fails, Program_Error is raised.</div>
<div class="paranum"><a name="p12">12/3</a></div>
<div class="Normal"><A NAME="I8594"></A>When a protected object is finalized, 
for any of its procedures that are attached to interrupts, the handler 
is detached. If the handler was attached by a procedure in the Interrupts 
package or if no user handler was previously attached to the interrupt, 
the default treatment is restored. If the Attach_Handler aspect was specified 
and the most recently attached handler for the same interrupt is the 
same as the one that was attached at the time the protected object was 
initialized, the previous handler is restored.&nbsp;</div>
<div class="paranum"><a name="p13">13</a></div>
<div class="Normal">When a handler is attached to an interrupt, the interrupt 
is blocked (subject to the Implementation Permission in <A HREF="RM-C-3.html">C.3</A>) 
during the execution of every protected action on the protected object 
containing the handler.</div>
<div class="paranum"><a name="p13.1">13.1/5</a></div>
<div class="Normal">&nbsp;&nbsp;If restriction No_Dynamic_Attachment is in effect, 
then a check is made that the interrupt identified by an Attach_Handler 
aspect does not appear in any previously elaborated Attach_Handler aspect; 
<A NAME="I8595"></A>Program_Error is raised if this check fails.</div>

<H4 Class="centered">Erroneous Execution</H4>
<div class="paranum"><a name="p14">14</a></div>
<div class="Normal"><A NAME="I8596"></A>If the Ceiling_Locking policy 
(see <A HREF="RM-D-3.html">D.3</A>) is in effect and an interrupt is 
delivered to a handler, and the interrupt hardware priority is higher 
than the ceiling priority of the corresponding protected object, the 
execution of the program is erroneous.</div>
<div class="paranum"><a name="p14.1">14.1/3</a></div>
<div class="Normal">&nbsp;&nbsp;<A NAME="I8597"></A>If the handlers for a given 
interrupt attached via aspect Attach_Handler are not attached and detached 
in a stack-like (LIFO) order, program execution is erroneous. In particular, 
when a protected object is finalized, the execution is erroneous if any 
of the procedures of the protected object are attached to interrupts 
via aspect Attach_Handler and the most recently attached handler for 
the same interrupt is not the same as the one that was attached at the 
time the protected object was initialized.&nbsp;</div>

<H4 Class="centered">Metrics</H4>
<div class="paranum"><a name="p15">15</a></div>
<div class="Normal" style="margin-bottom: 0.4em">The following metric 
shall be documented by the implementation:&nbsp;</div>
<div class="paranum"><a name="p16">16/2</a></div>
<div class="Bulleted">The worst-case overhead for an interrupt handler 
that is a parameterless protected procedure, in clock cycles. This is 
the execution time not directly attributable to the handler procedure 
or the interrupted execution. It is estimated as C &ndash; (A+B), where 
A is how long it takes to complete a given sequence of instructions without 
any interrupt, B is how long it takes to complete a normal call to a 
given protected procedure, and C is how long it takes to complete the 
same sequence of instructions when it is interrupted by one execution 
of the same procedure called via an interrupt.&nbsp;</div>

<H4 Class="centered">Implementation Permissions</H4>
<div class="paranum"><a name="p17">17/3</a></div>
<div class="Normal">When the aspects Attach_Handler or Interrupt_Handler 
are specified for a protected procedure, the implementation is allowed 
to impose implementation-defined restrictions on the corresponding <SPAN Class="swiss"><A HREF="RM-9-4.html#S0249">protected_type_declaration</A></SPAN> 
and <SPAN Class="swiss"><A HREF="RM-9-4.html#S0254">protected_body</A></SPAN>. 
</div>
<div class="paranum"><a name="p18">18</a></div>
<div class="Normal">An implementation may use a different mechanism for 
invoking a protected procedure in response to a hardware interrupt than 
is used for a call to that protected procedure from a task.&nbsp;</div>
<div class="paranum"><a name="p19">19/3</a></div>
<div class="Normal"><A NAME="I8598"></A>Notwithstanding what this subclause 
says elsewhere, the Attach_Handler and Interrupt_Handler aspects are 
allowed to be used for other, implementation defined, forms of interrupt 
handlers.&nbsp;</div>

<H4 Class="centered">Implementation Advice</H4>
<div class="paranum"><a name="p20">20</a></div>
<div class="Normal">Whenever possible, the implementation should allow 
interrupt handlers to be called directly by the hardware.&nbsp;</div>
<div class="paranum"><a name="p21">21</a></div>
<div class="Normal">Whenever practical, the implementation should detect 
violations of any implementation-defined restrictions before run time. 
</div>
<div class="paranum"><a name="p22">22/5</a></div>
<div class="Notes">NOTE 1&nbsp;&nbsp;&nbsp;The Attach_Handler aspect 
can provide static attachment of handlers to interrupts if the implementation 
supports preelaboration of protected objects. (See <A HREF="RM-C-4.html">C.4</A>.)</div>
<div class="paranum"><a name="p23">23/5</a></div>
<div class="Notes">NOTE 2&nbsp;&nbsp;&nbsp;For a protected object that 
has a (protected) procedure attached to an interrupt, the correct ceiling 
priority is at least as high as the highest processor priority at which 
that interrupt will ever be delivered.</div>
<div class="paranum"><a name="p24">24</a></div>
<div class="Notes">NOTE 3&nbsp;&nbsp;&nbsp;Protected procedures can also 
be attached dynamically to interrupts via operations declared in the 
predefined package Interrupts.</div>
<div class="paranum"><a name="p25">25</a></div>
<div class="Notes">NOTE 4&nbsp;&nbsp;&nbsp;An example of a possible implementation-defined 
restriction is disallowing the use of the standard storage pools within 
the body of a protected procedure that is an interrupt handler.</div>

<HR>
<div style="margin-top: 0.0em; margin-bottom: 0.6em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-4.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3-2.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</div>
<DIV Style="margin-top:0.0em"><IMG SRC="AE_logo.gif" height=100 width=113 align=right ALT="Ada-Europe">
<SPAN Style="vertical-align: middle; font-size:120%">Ada 2005 and 2012 Editions sponsored in part by <SPAN Style="font-size: 125%"><A HREF="http://www.ada-europe.org/"><B>Ada-Europe</B></A></SPAN></SPAN></DIV>
</BODY>
</HTML>
